import streamlit as st
import random
import time

# 🎉 정답 및 오답 메시지
정답_메시지 = [
    "목숨을 구했어요! 💖", "훌륭한 판단이었습니다! 👏", "응급처치 성공! 👍",
    "완벽한 응급 대응이었어요! 🏅", "사람을 살렸습니다! 👨‍⚕️"
]
오답_메시지 = [
    "죽었습니다..... ☠️", "실패했습니다..... 💀", "구조에 실패했습니다... 🩸",
    "응급처치 실패! 😵", "게임 오버... 🕹️"
]

# 🎬 GIF 모음
정답_GIF_목록 = [
    "https://media.giphy.com/media/l0MYt5jPR6QX5pnqM/giphy.gif",
    "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExdmFqOW5tbzVhZHlsMGUwcGQzdWxwN21iZm82MG1mcGhqY3U4OGlnYSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/s2qXK8wAvkHTO/giphy.gif",
    "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExdmFqOW5tbzVhZHlsMGUwcGQzdWxwN21iZm82MG1mcGhqY3U4OGlnYSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/IwAZ6dvvvaTtdI8SD5/giphy.gif"
]
오답_GIF_목록 = [
    "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExbGdoNHJ4bGRmYzQ5bDdiOWVybDlocjkyY203bzg0M3dqNGllZmIydCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/d2lcHJTG5Tscg/giphy.gif",
    "https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3eWdqaWppNmxxNDFqenIwaDUxYmt6eXA0YjA4dW5yMGlxZ3F3MXJxaiZlcD12MV9naWZzX3NlYXJjaCZjdD1n/erwW0QPCDN5QOe0BA1/giphy.gif",
    "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExZ2JxYW9lNXRkeTd1ZzR2dHB4a3V4NmwyMDNuOWJ1ZGZhYXdtZXV1OCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/10tIjpzIu8fe0/giphy.gif"
]

# 📋 퀴즈 데이터
quiz_data = [
    {
        "카테고리": "응급 상황",
        "상황": "친구가 식사 도중 갑자기 목을 움켜쥐며 숨을 쉬지 못해요.",
        "보기": ["등을 두드린다", "물을 마시게 한다", "복부 밀어올리기(하임리히법)를 한다", "기다린다"],
        "정답": "복부 밀어올리기(하임리히법)를 한다",
        "해설": "기도가 막혔을 경우에는 하임리히법으로 이물질을 제거해야 합니다."
    },
    {
        "카테고리": "의식 불명",
        "상황": "운동 중 친구가 의식을 잃고 쓰러졌어요. 가장 먼저 할 일은?",
        "보기": ["물을 마시게 한다", "심폐소생술을 한다", "의식 확인과 119 신고", "침착하게 기다린다"],
        "정답": "의식 확인과 119 신고",
        "해설": "먼저 반응 확인 후, 즉시 119에 신고해야 합니다."
    },
    {
        "카테고리": "심각한 부상",
        "상황": "친구가 팔을 다쳤고 뼈가 튀어나온 것처럼 보여요.",
        "보기": ["움직이게 한다", "부목으로 고정하고 병원 이송", "팔을 눌러본다", "냉찜질 후 놔둔다"],
        "정답": "부목으로 고정하고 병원 이송",
        "해설": "골절은 움직이지 않게 고정 후 병원으로 이송해야 합니다."
    },
    {
        "카테고리": "의식 불명",
        "상황": "친구가 운동 중 쓰러진 후 경련을 일으키고 있어요. 어떻게 해야 할까요?",
        "보기": ["몸을 세게 흔들어 깨운다", "입에 수건을 넣는다", "머리를 다치지 않게 하고 지켜본다", "물을 마시게 한다"],
        "정답": "머리를 다치지 않게 하고 지켜본다",
        "해설": "경련 중에는 움직임을 억지로 막지 말고 머리를 보호하고 안전하게 지켜보는 것이 중요합니다."
    },
    {
        "카테고리": "오염",
        "상황": "친구가 벌에 쏘였다고 해요. 어떻게 대처해야 할까요?",
        "보기": ["침을 손으로 짜낸다", "신용카드로 밀어 제거한다", "바늘로 쏜 자리를 찌른다", "냉찜질은 하지 않는다"],
        "정답": "신용카드로 밀어 제거한다",
        "해설": "벌침은 손으로 짜지 말고 신용카드 등으로 긁듯이 밀어 제거해야 합니다."
    },
    {
        "카테고리": "심각한 부상",
        "상황": "친구가 매우 뜨거운 물에 데였어요. 어떻게 해야 할까요?",
        "보기": ["로션을 바른다", "옷을 벗긴다", "흐르는 찬물에 10분 이상 식힌다", "손으로 문지른다"],
        "정답": "흐르는 찬물에 10분 이상 식힌다",
        "해설": "화상은 즉시 흐르는 찬물로 식히는 것이 가장 중요합니다."
    },
    {
        "카테고리": "가벼운 부상",
        "상황": "친구가 갑자기 어지럽다며 쓰러질 것 같다고 해요. 어떻게 해야 할까요?",
        "보기": ["일으켜 앉힌다", "바람을 쐬게 한다", "누이되 다리를 높인다", "팔을 주무른다"],
        "정답": "누이되 다리를 높인다",
        "해설": "어지러움이나 실신이 예상될 경우, 다리를 심장보다 높여 누이면 뇌혈류가 안정됩니다."
    },
    {
        "카테고리": "가벼운 질병",
        "상황": "식중독 증상이 있는 친구가 계속 구토하고 있어요. 어떻게 해야 할까요?",
        "보기": ["음식을 먹인다", "물을 억지로 마시게 한다", "수분을 조금씩 천천히 공급한다", "그냥 내버려둔다"],
        "정답": "수분을 조금씩 천천히 공급한다",
        "해설": "구토 시 탈수 예방을 위해 수분을 천천히 조금씩 공급해야 합니다."
    },
    {
        "카테고리": "가벼운 부상",
        "상황": "친구가 계단에서 넘어져 발목을 삐었어요. 어떻게 해야 할까요?",
        "보기": ["계속 움직이게 한다", "따뜻한 물에 담근다", "냉찜질하고 고정한다", "발을 주무른다"],
        "정답": "냉찜질하고 고정한다",
        "해설": "삔 부위는 냉찜질과 고정이 응급처치의 기본입니다."
    },
    {
        "카테고리": "응급 상황",
        "상황": "친구가 쓰러졌고, 숨을 쉬지 않아요. 어떻게 해야 하나요?",
        "보기": ["기다린다", "심폐소생술을 시작한다", "물을 뿌린다", "옆으로 눕힌다"],
        "정답": "심폐소생술을 시작한다",
        "해설": "의식과 호흡이 없을 경우 즉시 심폐소생술을 시행해야 합니다."
    },
    {
        "카테고리": "오염",
        "상황": "약품을 사용한 후 손을 제대로 씻지 않고 음식을 먹었어요. 어떤 문제가 발생할 수 있나요?",
        "보기": ["아무 문제 없다", "손이 더러워진다", "식중독 등 오염 가능성", "음식 맛이 없어진다"],
        "정답": "식중독 등 오염 가능성",
        "해설": "약품 성분이 남아있으면 음식 섭취 시 위험한 화학물질이 몸에 들어갈 수 있어요."
    },
    {
	"카테고리": "가벼운 부상",
	"상황": "뜨거운 냄비에 손을 데였어요. 어떻게 해야 할까요?",
        "보기": ["찬물에 손을 담근다", "로션을 바른다", "천으로 감싼다", "뜨거운 물로 씻는다"],
        "정답": "찬물에 손을 담근다",
        "해설": "화상 응급처치는 즉시 찬물로 열기를 빼는 것이 우선입니다."
    },
    {
        "카테고리": "오염",
	"상황": "친구가 눈에 이물질이 들어갔다고 해요. 어떻게 해야 할까요?",
        "보기": ["비비게 한다", "눈을 씻는다", "눈을 감고 기다리게 한다", "손으로 빼낸다"],
        "정답": "눈을 씻는다",
        "해설": "깨끗한 물로 눈을 씻어 이물질을 제거하는 것이 안전합니다."
    },
    {
        "카테고리": "심각한 질병",
	"상황": "친구가 낙상 후 허리 통증을 호소하며 못 움직이겠다고 해요.",
        "보기": ["일으켜본다", "지켜본다", "움직이지 않게 하고 구급차를 부른다", "걷게 해본다"],
        "정답": "움직이지 않게 하고 구급차를 부른다",
        "해설": "척추 손상이 의심될 경우 절대 움직이지 않고 구조를 요청해야 합니다."
    },
    {
        "카테고리": "의식 불명",
	"상황": "더운 날씨에 친구가 얼굴이 창백하고 식은땀을 흘려요.",
        "보기": ["운동을 시킨다", "그늘에서 쉬게 한다", "물을 끼얹는다", "무시한다"],
        "정답": "그늘에서 쉬게 한다",
        "해설": "더위로 인한 탈진이 의심되므로 시원한 곳에서 휴식을 취해야 합니다."
    },
    {
        "카테고리": "오염",
	"상황": "갑자기 코에 이물질이 들어갔어요. 어떻게 해야 할까요?",
        "보기": ["입으로 숨 쉬게 하고 병원에 간다", "코를 풀게 한다", "코를 세게 문지른다", "손가락을 넣어 빼게 한다"],
        "정답": "입으로 숨 쉬게 하고 병원에 간다",
        "해설": "이물질이 더 들어갈 수 있으므로 의료진의 도움이 필요합니다."
    },
    {
        "카테고리": "의식 불명",
	"상황": "오래 앉아 있다가 일어나니 어지럽다고 해요.",
        "보기": ["다시 앉히고 관찰한다", "걷게 한다", "물을 많이 마시게 한다", "무시한다"],
        "정답": "다시 앉히고 관찰한다",
        "해설": "저혈압 등으로 인한 일시적 현상일 수 있으니 안정을 취하게 해야 합니다."
    },
    {
        "카테고리": "심각한 질병",
	"상황": "친구가 열이 심하게 나고 몸이 떨린다고 해요.",
        "보기": ["따뜻하게 해준다", "찬물에 샤워시킨다", "해열제를 준다", "병원에 데려간다"],
        "정답": "병원에 데려간다",
        "해설": "고열과 오한은 감염 등 위중한 질병일 수 있으므로 의료기관 방문이 필요합니다."
    },
    {
        "카테고리": "심각한 부상",
	"상황": "손에 유리 파편이 박혔어요. 어떻게 해야 할까요?",
        "보기": ["빨리 뽑는다", "병원에 가기 전까지 그대로 둔다", "피가 나면 누른다", "무시한다"],
        "정답": "병원에 가기 전까지 그대로 둔다",
        "해설": "이물질 제거는 출혈이나 조직 손상을 유발할 수 있으므로 병원에서 처리해야 합니다."
    },
    {
        "카테고리": "가벼운 부상",
	"상황": "달리기를 하던 친구가 발을 헛디뎌 무릎에서 피가 납니다.",
        "보기": ["흙을 털고 방치한다", "소독하고 지혈한다", "찜질을 한다", "연고를 바른다"],
        "정답": "소독하고 지혈한다",
        "해설": "외상 응급처치는 세척과 지혈이 우선입니다."
    },
    {
        "카테고리": "가벼운 부상",
	"상황": "화학 실험 도중 액체가 팔에 튀었어요.",
        "보기": ["물로 씻는다", "마른 수건으로 닦는다", "연고를 바른다", "무시한다"],
        "정답": "물로 씻는다",
        "해설": "화학물질에 의한 화상은 즉시 물로 희석하는 것이 가장 중요합니다."
    },
    {
        "카테고리": "가벼운 부상",
	"상황": "운동 후 근육통을 호소하는 친구에게 적절한 처치는?",
        "보기": ["냉찜질", "뜨거운 물에 담그기", "마사지", "스트레칭"],
        "정답": "냉찜질",
        "해설": "운동 직후에는 염증을 줄이기 위해 냉찜질이 적절합니다."
    },
    {
        "카테고리": "심각한 질병",
	"상황": "친구가 갑자기 손이 떨리고 식은땀을 흘려요. 저혈당이 의심됩니다. 어떻게 해야 할까요?",
        "보기": ["단 음식을 먹인다", "운동시킨다", "냉찜질한다", "물을 많이 준다"],
        "정답": "단 음식을 먹인다",
        "해설": "저혈당일 경우 빠르게 당을 공급해야 합니다."
    },
    {
        "카테고리": "가벼운 부상",
	"상황": "눈 밑에 멍이 들고 코피도 나는 친구가 있어요. 어떻게 해야 할까요?",
        "보기": ["냉찜질한다", "코를 세게 문지른다", "뜨거운 수건을 댄다", "머리를 숙인다"],
        "정답": "냉찜질한다",
        "해설": "멍이나 출혈이 있을 경우 냉찜질로 혈관을 수축시켜야 합니다."
    },
    {
        "카테고리": "응급 상황",
	"상황": "물을 마시다 기도로 넘어가 기침을 심하게 하고 있어요.",
        "보기": ["등을 두드려준다", "물을 더 마시게 한다", "복부를 누른다", "기다린다"],
        "정답": "등을 두드려준다",
        "해설": "기침이 가능하다면 등 두드리기로 도와주되, 기도가 완전히 막힌 경우 하임리히법을 적용합니다."
    },
    {
        "카테고리": "심각한 부상",
	"상황": "얼음 위에서 넘어져 엉덩이를 세게 부딪혔다고 해요.",
        "보기": ["앉게 한다", "일단 눕히고 움직이지 않게 한다", "걷게 한다", "찜질을 한다"],
        "정답": "일단 눕히고 움직이지 않게 한다",
        "해설": "골반 골절 가능성이 있으므로 움직임을 최소화해야 합니다."
    }
]

# 🧠 세션 초기화
if "문제순서" not in st.session_state:
    st.session_state.문제순서 = random.sample(range(len(quiz_data)), len(quiz_data))
if "문제번호" not in st.session_state:
    st.session_state.문제번호 = 0
if "점수" not in st.session_state:
    st.session_state.점수 = 0
if "정답상태" not in st.session_state:
    st.session_state.정답상태 = None
if "오답노트" not in st.session_state:
    st.session_state.오답노트 = []
if "시작시간" not in st.session_state:
    st.session_state.시작시간 = time.time()

# ✅ 퀴즈 종료
if st.session_state.문제번호 >= len(quiz_data):
    st.success(f"🎓 퀴즈 완료! {len(quiz_data)}문제 중 {st.session_state.점수}문제 정답 👏")
    비율 = st.session_state.점수 / len(quiz_data)
    st.progress(int(비율 * 100))
    st.write(f"정답률: {비율*100:.1f}%")

    if 비율 == 1.0:
        st.balloons()
        st.success("완벽합니다! 훌륭한 응급처치 지식 보유자!")
    elif 비율 >= 0.7:
        st.info("좋아요! 하지만 몇 가지 복습이 필요해요.")
    else:
        st.warning("기초부터 다시 복습해보는 게 좋겠어요!")

    if st.session_state.오답노트:
        st.subheader("📒 오답노트")
        for 오답 in st.session_state.오답노트:
            st.markdown(f"- **상황:** {오답['상황']}")
            st.markdown(f"  - ❌ 당신의 답: {오답['선택']}")
            st.markdown(f"  - ✅ 정답: {오답['정답']}")
            st.markdown(f"  - 💡 해설: {오답['해설']}")

    if st.button("🔁 다시 시작하기"):
        st.session_state.문제번호 = 0
        st.session_state.점수 = 0
        st.session_state.정답상태 = None
        st.session_state.오답노트 = []
        st.session_state.문제순서 = random.sample(range(len(quiz_data)), len(quiz_data))
        st.session_state.시작시간 = time.time()
        st.rerun()
    st.stop()

# 🎯 문제 출제
문제인덱스 = st.session_state.문제순서[st.session_state.문제번호]
문제 = quiz_data[문제인덱스]

st.title("🆘 응급처치 상황 퀴즈")
st.subheader(f"문제 {st.session_state.문제번호 + 1} / {len(quiz_data)}")
st.write(f"**카테고리:** _{문제['카테고리']}_")
st.write(f"**상황:** {문제['상황']}")

# ⏱️ 타이머
남은시간 = 15 - int(time.time() - st.session_state.시작시간)
st.info(f"⏱️ 남은 시간: {남은시간}초")
if 남은시간 <= 0:
    st.error("⏰ 시간 초과! 오답으로 처리됩니다.")
    st.image(random.choice(오답_GIF_목록), use_column_width=True)
    st.session_state.오답노트.append({
        "상황": 문제["상황"],
        "선택": "시간 초과",
        "정답": 문제["정답"],
        "해설": 문제["해설"]
    })
    st.session_state.문제번호 += 1
    st.session_state.정답상태 = None
    st.session_state.시작시간 = time.time()
    st.rerun()

선택 = st.radio("당신의 선택은?", 문제["보기"], key=st.session_state.문제번호)

# 🔘 정답 제출
if st.button("정답 제출"):
    if time.time() - st.session_state.시작시간 > 15:
        st.error("⏰ 제출이 늦었습니다! 오답으로 처리됩니다.")
        st.image(random.choice(오답_GIF_목록), use_column_width=True)
        st.session_state.오답노트.append({
            "상황": 문제["상황"],
            "선택": "지각 제출",
            "정답": 문제["정답"],
            "해설": 문제["해설"]
        })
        st.session_state.문제번호 += 1
        st.session_state.정답상태 = None
        st.session_state.시작시간 = time.time()
        st.rerun()

    if 선택 == 문제["정답"]:
        st.success(f"정답입니다! ✅ {random.choice(정답_메시지)}")
        st.image(random.choice(정답_GIF_목록), use_column_width=True)
        st.session_state.점수 += 1
        st.session_state.정답상태 = "정답"
    else:
        st.error(random.choice(오답_메시지))
        st.image(random.choice(오답_GIF_목록), use_column_width=True)
        st.info(f"💡 해설: {문제['해설']}")
        st.session_state.정답상태 = "오답"

# ➡ 다음 문제
if st.session_state.정답상태 == "정답":
    st.info(f"💡 해설: {문제['해설']}")
    if st.button("➡ 다음 문제로"):
        st.session_state.문제번호 += 1
        st.session_state.정답상태 = None
        st.session_state.시작시간 = time.time()
        st.rerun()

# ❌ 오답 다음 문제로
if st.session_state.정답상태 == "오답" and st.button("❌ 포기하고 다음 문제로"):
    st.session_state.오답노트.append({
        "상황": 문제["상황"],
        "선택": 선택,
        "정답": 문제["정답"],
        "해설": 문제["해설"]
    })
    st.session_state.문제번호 += 1
    st.session_state.정답상태 = None
    st.session_state.시작시간 = time.time()
    st.rerun()
